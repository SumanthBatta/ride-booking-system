<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org">
<head>
    <title>Ride Booking System</title>
    <link href="/css/style.css" rel="stylesheet">
    <style>
        * {
            color: inherit;
        }
        
        h1, h2, h3, h4, h5, h6 {
            color: #1a1a1a !important;
        }
        
        p, span, div, label {
            color: #666 !important;
        }
        
        input {
            color: #333 !important;
        }
        .platform-selection {
            margin-top: 30px;
            animation: slideIn 0.3s ease-out;
        }
        
        .platform-selection h3 {
            text-align: center;
            margin-bottom: 20px;
            color: #333;
        }
        
        .platform-cards {
            display: flex;
            gap: 15px;
            margin-bottom: 20px;
        }
        
        .platform-card-horizontal {
            flex: 1;
            height: 120px;
            border-radius: 15px;
            position: relative;
            overflow: hidden;
            cursor: pointer;
            transition: all 0.3s ease;
            box-shadow: 0 4px 15px rgba(0,0,0,0.1);
        }
        
        .platform-card-horizontal:hover {
            transform: translateY(-5px);
            box-shadow: 0 8px 25px rgba(0,0,0,0.2);
        }
        
        .platform-bg {
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background-size: cover;
            background-position: center;
        }
        
        .uber-bg {
            background: linear-gradient(135deg, #000000 0%, #434343 100%);
        }
        
        .ola-bg {
            background: linear-gradient(135deg, #FFE135 0%, #FFC107 100%);
        }
        
        .rapido-bg {
            background: linear-gradient(135deg, #FF6B35 0%, #F7931E 100%);
        }
        
        .platform-content {
            position: relative;
            z-index: 2;
            padding: 15px;
            height: 100%;
            display: flex;
            flex-direction: column;
            justify-content: center;
            text-align: center;
            color: white;
        }
        
        .ola-card .platform-content {
            color: #333;
        }
        
        .platform-content h4 {
            margin: 8px 0 4px 0;
            font-size: 18px;
            font-weight: 600;
        }
        
        .platform-content p {
            margin: 0;
            font-size: 12px;
            opacity: 0.9;
        }
        
        .vehicle-selection {
            margin-top: 30px;
            animation: slideIn 0.3s ease-out;
        }
        
        .selected-platform-header {
            display: flex;
            align-items: center;
            margin-bottom: 20px;
        }
        
        .back-btn-small {
            background: #f8f9fa;
            border: none;
            padding: 8px 12px;
            border-radius: 8px;
            margin-right: 15px;
            cursor: pointer;
            font-size: 14px;
        }
        
        .vehicle-options {
            display: flex;
            flex-direction: column;
            gap: 12px;
            margin-bottom: 20px;
        }
        
        .vehicle-card {
            display: flex;
            align-items: center;
            padding: 15px;
            background: white;
            border-radius: 12px;
            box-shadow: 0 2px 8px rgba(0,0,0,0.1);
            cursor: pointer;
            transition: all 0.2s ease;
            border: 2px solid transparent;
        }
        
        .vehicle-card:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 15px rgba(0,0,0,0.15);
        }
        
        .vehicle-card.selected {
            border-color: #667eea;
            background: linear-gradient(135deg, #667eea15 0%, #764ba215 100%);
        }
        
        .vehicle-card.disabled {
            opacity: 0.5;
            cursor: not-allowed;
        }
        
        .vehicle-icon-large {
            font-size: 32px;
            margin-right: 15px;
            width: 50px;
            text-align: center;
        }
        
        .vehicle-info {
            flex: 1;
        }
        
        .vehicle-info h4 {
            margin: 0 0 4px 0;
            font-size: 16px;
            font-weight: 600;
            color: #333;
        }
        
        .vehicle-eta, .vehicle-distance {
            margin: 2px 0;
            font-size: 12px;
            color: #666;
        }
        
        .vehicle-price {
            text-align: right;
        }
        
        .price-large {
            font-size: 20px;
            font-weight: 700;
            color: #10b981;
            display: block;
        }
        
        .availability {
            font-size: 11px;
            color: #10b981;
        }
        
        .unavailable {
            font-size: 11px;
            color: #ef4444;
        }
        
        .location-suggestions {
            position: absolute;
            top: 100%;
            left: 0;
            right: 0;
            background: white;
            border: 1px solid #ddd;
            border-top: none;
            border-radius: 0 0 8px 8px;
            box-shadow: 0 4px 12px rgba(0,0,0,0.1);
            z-index: 1000;
            max-height: 200px;
            overflow-y: auto;
        }
        
        .suggestion-item {
            display: flex;
            align-items: center;
            padding: 12px 15px;
            cursor: pointer;
            border-bottom: 1px solid #f0f0f0;
            transition: background 0.2s;
        }
        
        .suggestion-item:hover {
            background: #f8f9fa;
        }
        
        .suggestion-item:last-child {
            border-bottom: none;
        }
        
        .suggestion-icon {
            margin-right: 12px;
            font-size: 16px;
        }
        
        .suggestion-content {
            flex: 1;
        }
        
        .suggestion-title {
            font-weight: 500;
            color: #333;
            font-size: 14px;
        }
        
        .suggestion-subtitle {
            font-size: 12px;
            color: #666;
            margin-top: 2px;
        }
        
        .suggestion-item.loading,
        .suggestion-item.no-results,
        .suggestion-item.error {
            justify-content: center;
            color: #666;
            font-size: 14px;
        }
        
        .form-group {
            position: relative;
        }
        
        @keyframes slideIn {
            from {
                opacity: 0;
                transform: translateY(20px);
            }
            to {
                opacity: 1;
                transform: translateY(0);
            }
        }
        
        @media (max-width: 768px) {
            .platform-cards {
                flex-direction: column;
            }
            
            .platform-card-horizontal {
                height: 80px;
            }
        }
    </style>
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>üë§ Book Your Ride</h1>
            <div class="user-info">
                <span th:text="'Welcome, ' + ${user.fullName}">Welcome, User</span>
                <a href="/my-rides" class="link-btn">My Rides</a>
                <a href="/logout" class="link-btn">Logout</a>
            </div>
        </div>
        
        <div class="map-container">
            <div id="map"></div>
            <div class="map-controls">
                <button id="getCurrentLocation" class="location-btn">üìç Use Current Location</button>
                <button id="setPickup" class="map-btn">Set as Pickup</button>
                <button id="setDrop" class="map-btn">Set as Drop</button>
            </div>
        </div>

        <form th:action="@{/book-ride}" th:object="${rideRequest}" method="post" id="mainForm">
            <div class="form-group">
                <label>Pickup Location:</label>
                <input type="text" id="pickupInput" th:field="*{pickup}" placeholder="Enter pickup location" required autocomplete="off">
                <div id="pickupSuggestions" class="location-suggestions"></div>
                <input type="hidden" id="pickupLat" name="pickupLat">
                <input type="hidden" id="pickupLng" name="pickupLng">
            </div>
            
            <div class="form-group">
                <label>Drop Location:</label>
                <input type="text" id="dropInput" th:field="*{drop}" placeholder="Enter destination" required autocomplete="off">
                <div id="dropSuggestions" class="location-suggestions"></div>
                <input type="hidden" id="dropLat" name="dropLat">
                <input type="hidden" id="dropLng" name="dropLng">
            </div>
            
            <button type="button" class="btn primary" id="continueBtn">
                Continue
            </button>
        </form>

        <script>
            let map, pickupMarker, dropMarker, currentLocationMarker;
            let selectedLocation = null;

            // Initialize map when page loads
            document.addEventListener('DOMContentLoaded', function() {
                // Default to Bangalore
                map = L.map('map').setView([12.9716, 77.5946], 13);

                // Add OpenStreetMap tiles
                L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
                    attribution: '¬© OpenStreetMap contributors'
                }).addTo(map);

                // Map click handler
                map.on('click', function(e) {
                    const lat = e.latlng.lat;
                    const lng = e.latlng.lng;
                    
                    // Reverse geocoding using Nominatim
                    fetch(`https://nominatim.openstreetmap.org/reverse?format=json&lat=${lat}&lon=${lng}`)
                        .then(response => response.json())
                        .then(data => {
                            const address = data.display_name || `${lat.toFixed(4)}, ${lng.toFixed(4)}`;
                            selectedLocation = {lat: lat, lng: lng, address: address};
                            
                            // Add temporary marker
                            if (window.tempMarker) map.removeLayer(window.tempMarker);
                            window.tempMarker = L.marker([lat, lng]).addTo(map)
                                .bindPopup('Click "Set as Pickup" or "Set as Drop"').openPopup();
                        });
                });
            });

            function getCurrentLocation() {
                if (navigator.geolocation) {
                    navigator.geolocation.getCurrentPosition(function(position) {
                        const lat = position.coords.latitude;
                        const lng = position.coords.longitude;
                        
                        map.setView([lat, lng], 15);
                        
                        // Get area name using reverse geocoding
                        fetch(`https://nominatim.openstreetmap.org/reverse?format=json&lat=${lat}&lon=${lng}`)
                            .then(response => response.json())
                            .then(data => {
                                const areaName = data.address?.suburb || data.address?.neighbourhood || 
                                               data.address?.city_district || data.address?.town || 
                                               data.address?.city || 'Current Location';
                                
                                if (currentLocationMarker) map.removeLayer(currentLocationMarker);
                                currentLocationMarker = L.marker([lat, lng], {
                                    icon: L.icon({
                                        iconUrl: 'https://raw.githubusercontent.com/pointhi/leaflet-color-markers/master/img/marker-icon-blue.png',
                                        iconSize: [25, 41],
                                        iconAnchor: [12, 41]
                                    })
                                }).addTo(map).bindPopup(`Your Location: ${areaName}`);
                                
                                selectedLocation = {lat: lat, lng: lng, address: areaName};
                            })
                            .catch(() => {
                                // Fallback if geocoding fails
                                if (currentLocationMarker) map.removeLayer(currentLocationMarker);
                                currentLocationMarker = L.marker([lat, lng], {
                                    icon: L.icon({
                                        iconUrl: 'https://raw.githubusercontent.com/pointhi/leaflet-color-markers/master/img/marker-icon-blue.png',
                                        iconSize: [25, 41],
                                        iconAnchor: [12, 41]
                                    })
                                }).addTo(map).bindPopup('Your Current Location');
                                
                                selectedLocation = {lat: lat, lng: lng, address: 'Current Location'};
                            });
                    });
                }
            }

            function setPickupLocation() {
                if (!selectedLocation) {
                    alert('Please click on the map to select a location first');
                    return;
                }
                
                if (pickupMarker) map.removeLayer(pickupMarker);
                pickupMarker = L.marker([selectedLocation.lat, selectedLocation.lng], {
                    icon: L.icon({
                        iconUrl: 'https://raw.githubusercontent.com/pointhi/leaflet-color-markers/master/img/marker-icon-green.png',
                        iconSize: [25, 41],
                        iconAnchor: [12, 41]
                    })
                }).addTo(map).bindPopup('Pickup Location');
                
                document.getElementById('pickupInput').value = selectedLocation.address;
                document.getElementById('pickupLat').value = selectedLocation.lat;
                document.getElementById('pickupLng').value = selectedLocation.lng;
            }

            function setDropLocation() {
                if (!selectedLocation) {
                    alert('Please click on the map to select a location first');
                    return;
                }
                
                if (dropMarker) map.removeLayer(dropMarker);
                dropMarker = L.marker([selectedLocation.lat, selectedLocation.lng], {
                    icon: L.icon({
                        iconUrl: 'https://raw.githubusercontent.com/pointhi/leaflet-color-markers/master/img/marker-icon-red.png',
                        iconSize: [25, 41],
                        iconAnchor: [12, 41]
                    })
                }).addTo(map).bindPopup('Drop Location');
                
                document.getElementById('dropInput').value = selectedLocation.address;
                document.getElementById('dropLat').value = selectedLocation.lat;
                document.getElementById('dropLng').value = selectedLocation.lng;
            }

            // Button event listeners
            document.getElementById('getCurrentLocation').addEventListener('click', getCurrentLocation);
            document.getElementById('setPickup').addEventListener('click', setPickupLocation);
            document.getElementById('setDrop').addEventListener('click', setDropLocation);
            document.getElementById('continueBtn').addEventListener('click', showPlatforms);
            
            // Setup location suggestions
            setupLocationSuggestions();
            
            function setupLocationSuggestions() {
                const pickupInput = document.getElementById('pickupInput');
                const dropInput = document.getElementById('dropInput');
                
                pickupInput.addEventListener('input', function() {
                    showLocationSuggestions(this.value, 'pickupSuggestions', 'pickup');
                });
                
                dropInput.addEventListener('input', function() {
                    showLocationSuggestions(this.value, 'dropSuggestions', 'drop');
                });
                
                // Hide suggestions when clicking outside
                document.addEventListener('click', function(e) {
                    if (!e.target.closest('.form-group')) {
                        document.querySelectorAll('.location-suggestions').forEach(s => s.style.display = 'none');
                    }
                });
            }
            
            async function showLocationSuggestions(query, containerId, type) {
                const container = document.getElementById(containerId);
                
                if (query.length < 2) {
                    container.style.display = 'none';
                    return;
                }
                
                // Show loading
                container.innerHTML = '<div class="suggestion-item loading">Searching...</div>';
                container.style.display = 'block';
                
                try {
                    // Use Nominatim for location suggestions
                    const response = await fetch(`https://nominatim.openstreetmap.org/search?format=json&limit=5&q=${encodeURIComponent(query + ', India')}`);
                    const results = await response.json();
                    
                    if (results.length === 0) {
                        container.innerHTML = '<div class="suggestion-item no-results">No locations found</div>';
                        return;
                    }
                    
                    container.innerHTML = '';
                    results.forEach(result => {
                        const suggestionItem = document.createElement('div');
                        suggestionItem.className = 'suggestion-item';
                        suggestionItem.innerHTML = `
                            <div class="suggestion-icon">üìç</div>
                            <div class="suggestion-content">
                                <div class="suggestion-title">${result.display_name.split(',')[0]}</div>
                                <div class="suggestion-subtitle">${result.display_name}</div>
                            </div>
                        `;
                        
                        suggestionItem.addEventListener('click', function() {
                            selectLocationSuggestion(result, type);
                            container.style.display = 'none';
                        });
                        
                        container.appendChild(suggestionItem);
                    });
                } catch (error) {
                    console.error('Error fetching suggestions:', error);
                    container.innerHTML = '<div class="suggestion-item error">Error loading suggestions</div>';
                }
            }
            
            function selectLocationSuggestion(location, type) {
                const input = document.getElementById(type + 'Input');
                const latInput = document.getElementById(type + 'Lat');
                const lngInput = document.getElementById(type + 'Lng');
                
                input.value = location.display_name;
                latInput.value = location.lat;
                lngInput.value = location.lon;
                
                // Add marker to map
                const lat = parseFloat(location.lat);
                const lng = parseFloat(location.lon);
                
                if (type === 'pickup') {
                    if (pickupMarker) map.removeLayer(pickupMarker);
                    pickupMarker = L.marker([lat, lng], {
                        icon: L.icon({
                            iconUrl: 'https://raw.githubusercontent.com/pointhi/leaflet-color-markers/master/img/marker-icon-green.png',
                            iconSize: [25, 41],
                            iconAnchor: [12, 41]
                        })
                    }).addTo(map).bindPopup('Pickup Location');
                } else {
                    if (dropMarker) map.removeLayer(dropMarker);
                    dropMarker = L.marker([lat, lng], {
                        icon: L.icon({
                            iconUrl: 'https://raw.githubusercontent.com/pointhi/leaflet-color-markers/master/img/marker-icon-red.png',
                            iconSize: [25, 41],
                            iconAnchor: [12, 41]
                        })
                    }).addTo(map).bindPopup('Drop Location');
                }
                
                // Center map if both locations are set
                if (pickupMarker && dropMarker) {
                    const group = new L.featureGroup([pickupMarker, dropMarker]);
                    map.fitBounds(group.getBounds().pad(0.1));
                }
            }
            
            console.log('Passenger page loaded successfully');
            
            function showPlatforms() {
                console.log('showPlatforms called');
                const pickup = document.getElementById('pickupInput').value;
                const drop = document.getElementById('dropInput').value;
                const pickupLat = document.getElementById('pickupLat').value;
                const pickupLng = document.getElementById('pickupLng').value;
                const dropLat = document.getElementById('dropLat').value;
                const dropLng = document.getElementById('dropLng').value;
                
                console.log('Pickup:', pickup, 'Drop:', drop);
                
                if (!pickup || !drop) {
                    alert('Please select both pickup and drop locations');
                    return;
                }
                
                // Navigate to platform selection page
                const params = new URLSearchParams({
                    pickup: pickup,
                    drop: drop,
                    pickupLat: pickupLat || '',
                    pickupLng: pickupLng || '',
                    dropLat: dropLat || '',
                    dropLng: dropLng || ''
                });
                
                window.location.href = '/platform-selection?' + params.toString();
            }

        </script>
    </div>
</body>
</html>